services:
  immich-server:
    container_name: immich
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION}
    command: [ "start.sh", "immich" ]
    volumes:
      - ${UPLOAD_LOCATION}:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro
      - /mnt/data_drive:/mnt/media/external:ro
    env_file:
      - .env
      - ../../.env
    environment:
      - DB_PASSWORD_FILE=/run/secrets/db_password
    secrets:
      - db_password
    depends_on:
      - immich-redis
      - immich-postgres
    restart: unless-stopped
    networks:
      - frontend_net
      - backend_net

  immich-microservices:
    container_name: immich_microservices
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION}
    command: [ "start.sh", "microservices" ]
    volumes:
      - ${UPLOAD_LOCATION}:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro
      - /mnt/data_drive:/mnt/media/external:ro
    env_file:
      - .env
      - ../../.env
    environment:
      - DB_PASSWORD_FILE=/run/secrets/db_password
    secrets:
      - db_password
    depends_on:
      - immich-redis
      - immich-postgres
    restart: unless-stopped
    networks:
      - backend_net

  immich-machine-learning:
    container_name: immich_machine_learning
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION}
    volumes:
      - model-cache:/cache
    env_file:
      - .env
      - ../../.env
    restart: unless-stopped
    networks:
      - backend_net

  immich-redis:
    container_name: immich_redis
    # FIX: Use official hardened Alpine tag (removed broken hash)
    image: redis:6.2-alpine
    restart: unless-stopped
    networks:
      - backend_net

  immich-postgres:
    container_name: immich_postgres
    # FIX 1: Use the correct image with AI vector support
    image: tensorchord/pgvecto-rs:pg14-v0.2.0
    environment:
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
      - POSTGRES_USER=${DB_USERNAME}
      - POSTGRES_DB=${DB_DATABASE_NAME}
      - PG_DATA=/var/lib/postgresql/data
    env_file:
      - ../../.env
    secrets:
      - db_password
    volumes:
      - pgdata:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - backend_net

secrets:
  db_password:
    file: ../../secrets/immich/db_password.txt

volumes:
  model-cache:
  pgdata:

networks:
  frontend_net:
    external: true
  backend_net:
    external: true
